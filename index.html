<!DOCTYPE html>
<meta charset="utf-8">
<div id="toast" hidden></div>

<head>
    <style rel="stylesheet" type="text/css">

        a:hover {color: rgb(0, 0, 216)}
        a:active {color: rgb(57, 78, 160)}
 

        body.no-scroll {
            overflow: hidden;
        }

        .site {
            max-width: 1200px;
            margin: 0.2em;
        }

        .bg {
            background-size: inherit;
            background: url("https://raw.githubusercontent.com/fpga2033/TVtower/gh-pages/bg.jpg") center center;
            height: 505px;
            width: 100%;
            margin-left: -0%;
            margin-top: 3em;
            margin-bottom: 0em;
        }

        .my-modal {
            position: fixed;
            background-color: rgba(255, 255, 255, 0.9);
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            overflow: auto;
        }

        .my-modal-content {
            position: fixed;
            width: 285px;        /* 调整这个宽度，和JTB界面拼接在一起*/
            height: 620px;
            text-align: left;
            padding: 1em;
            background-color: white;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.29), 0 26px 52px rgba(0, 0, 0, 0.26);
        }

        @media only screen and (min-width: 300px) {
            .my-modal-content {
                right: 0%;
                margin-right: -0px;
            }
        }
        @media only screen and (min-height: 580px) {
            .my-modal-content {
                top: 0%;
                margin-top: -0px;
            }
        }

    </style>

</head>

<body>
    <div class="site">
        <section>
            <title>☆♪ Sapporo TV Hotel ♪☆</title>
            
            <a style="font-size:15px">REF#: </a><label class="control-label" id=txt_ref style="font-size:18px;font-family:verdana;color:rgb(23, 94, 248)"></label>
            <button id="btn_JTB_confirmed" class="btn btn-primary" style="font-size:14px;font-family:Meiryo;float:right"><strong>ＪＴＢ完成</strong><br><em>(去填集計草稿)</em></button><br/>
            <a style="font-size:16px">★ </a><label class="control-label" id=txt_type style="font-size:15px"></label><br/>
            
            <img hight="15%" width="100%" class="img-rounded" src="https://raw.githubusercontent.com/fpga2033/TVtower/0609769e290f5f11ccf79624a39f594c03a2a4eb/mildseven-hill-winter.jpg" alt="" /><br/>

            <a>总额:　JPY </a><label class="control-label" id=txt_price style="font-size:22px;font-family:verdana;color:red"></label><br/><br/>
            <a style="font-size:12px">男  </a><label class="control-label" id=txt_male_female style="font-weight:bold;font-size:20px;color:rgb(9, 15, 68)"></label><br/><br/>
            <label class="control-label" id=txt_checkin style="font-weight:bold;font-size:18px;color:rgb(86, 0, 121)"></label>
            <a style="font-size:12px"> より </a><label class="control-label" id=txt_days style="font-weight:bold;font-size:20px;color:rgb(86, 0, 121)"></label><a style="font-size:12px"> 日間　　　</a>
            <label class="control-label" id=txt_rooms style="font-weight:bold;font-size:20px;color:rgb(86, 0, 121)"></label><a style="font-size:12px"> 室</a><br/>
            <br/>
            
            <label class="control-label" id=txt_hotel_roomtype></label><br/><br/>
            <label class="control-label" id=txt_eachroom_meal></label><br/><br/>
            <br/>
            
            <label class="control-label" id=txt_guest1></label><br/><br/>
            <label class="control-label" id=txt_request style="font-size:14px"></label><br/><br/>


            <form>
                <div class="form-group">
                </div>
            </form>
            
            
        </section>
        <!--<div class="bg"></div>   这是BackGround图片 -->
    </div>

    <div class="my-modal">
        <div class="my-modal-content">
            <img hight="10%" width="100%" class="img-rounded" src="https://www.jph.co.jp/wp-content/uploads/2018/10/Artboard-2-2.png" alt="" />
            
            <div class="modal-body">
            </div>
                        
            <button id="btn_modal_confirmed" class="btn btn-primary">Close</button>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script type="text/javascript">

        var $body = $('body');
        var report_summary;
        var HnameSummary;


        // HnameTable酒店资料数组初始化
        Hotel_information: { /*

            var HnameTable = new Array();
            for( var hi=0; hi<90; hi++ ){        //一维长度为3
                HnameTable[hi] = new Array();
                for( var hj=0; hj<6; hj++ ){    //二维长度为5
                    HnameTable[hi][hj] = "";
                }
            }
            HnameTable[0]=["塔娃","星野塔娃","星野リゾート　トマム・ザ・タワー","en","",""];
            HnameTable[1]=["Riso","星野Risonare","星野リゾート　リゾナーレトマム","en","",""];
            HnameTable[2]=["希尔顿","Hilton二世古","ヒルトンニセコビレッジ","en","",""];
            HnameTable[3]=["Alpen","二世古Alpen","ホテルニセコアルペン","en","",""];
            HnameTable[4]=["安努普","二世古R安努","ニセコノーザンリゾート　アンヌプリ","en","",""];
            HnameTable[5]=["世古塔","二世古塔","ワンニセコリゾートタワーズ","en","",""];
            HnameTable[6]=["谷臻品","キロロ","キロロ トリビュートポートフォリオホテル","en","",""];
            HnameTable[7]=["威斯汀","Westinルスツ","ウエスティンルスツリゾート","en","",""];
            HnameTable[8]=["及会议","ルスツ RC","ルスツリゾートホテル＆コンベンション","en","",""];
            HnameTable[9]=["日航","JR日航","JR タワーホテル日航","en","",""];
            HnameTable[10]=["格拉斯丽","格拉斯丽","ホテルグレイスリー札幌","en","",""];
            HnameTable[11]=["世纪皇家","世纪皇家","センチュリーロイヤルホテル札幌","en","",""];
            HnameTable[12]=["京王","京王プラザ","京王プラザホテル札幌","en","",""];
            HnameTable[13]=["北口","Mystay北口","ホテルマイステイズ札幌駅北口（旧ホテルフィーノ札幌）","en","",""];
            HnameTable[14]=["格兰","札幌格兰","札幌グランドホテル","en","",""];
            HnameTable[15]=["唐草","札幌唐草","からくさホテル札幌","en","",""];
            HnameTable[16]=["東急商","東急REI","札幌東急REI　ホテル","en","",""];
            HnameTable[17]=["克罗斯","克罗斯","クロスホテル札幌","en","",""];
            HnameTable[18]=["罗伊顿","罗伊顿札幌","ロイトン札幌","en","",""];
            HnameTable[19]=["三井","三井花园","三井ガーデンホテル札幌","en","",""];
            HnameTable[20]=["滝本","第一滝本","登別第一滝本館","en","",""];
            HnameTable[21]=["登別万","登別万世閣","登別万世閣","en","",""];
            HnameTable[22]=["仙境","まほろば","ホテルまほろば","en","",""];
            HnameTable[23]=["登别格","登別グランド","登別グランドホテル","en","",""];
            HnameTable[24]=["石水亭","登別石水亭","登別石水亭","en","",""];
            HnameTable[25]=["雅亭","登別雅亭","名湯の宿パークホテル雅亭","en","",""];
            HnameTable[26]=["乃之风","TOYA乃の風","ザ・レイクビューTOYA乃の風リゾート","en","",""];
            HnameTable[27]=["湖山水","洞爺湖山水","洞爺湖山水ホテル和風","en","",""];
            HnameTable[28]=["湖畔亭","洞爺湖畔亭","洞爺湖畔亭","en","",""];
            HnameTable[29]=["爷观光","洞爺観光","洞爺観光ホテル","en","",""];
            HnameTable[30]=["湖温莎","洞爺温莎","ザ・ウンインザーホテル洞爺リゾート＆スパ","en","",""];
            HnameTable[31]=["太阳宫","洞爺サン","洞爺サンパレス","en","",""];
            HnameTable[32]=["章月","章月格兰","章月グランドホテル","en","",""];
            HnameTable[33]=["拉碧斯","LAVIS函館","ＬＡ　ＶＩＳＴＡ函館ベイ","en","",""];
            HnameTable[34]=["福朋","福朋函館","フォーポイントバイシェラトン函館","en","",""];
            HnameTable[35]=["君乐","グランド小樽","グランドパーク小樽","en","",""];
            HnameTable[36]=["多米","小樽多米","ドーミーインPREMIUM小樽","en","",""];
            HnameTable[37]=["银鳞","銀鱗荘","銀鱗荘","en","",""];
            HnameTable[38]=["峡观光","層雲峡観光","層雲峡観光ホテル","en","",""];
            HnameTable[39]=["朝陽亭","層雲峡朝陽","層雲峡朝陽亭 ","en","",""];
            HnameTable[40]=["大雪","層雲峡大雪","層雲峡ホテル大雪","en","",""];
            HnameTable[41]=["御前水","阿寒御前水","ホテル御前水","en","",""];
            HnameTable[42]=["ART","旭川艺术","アートホテル旭川","en","",""];
            HnameTable[43]=["那图瓦","富良野森林","ホテルナトゥールヴァルト富良野","en","",""];
            HnameTable[44]=["新富良","新富良野Ｐ","新富良野プリンスホテル","en","",""];
        */
        }


        // 按钮"JTB完成"
        $('#btn_JTB_confirmed').on('click', function () {
            //alert(" 饿丝了啊 ")
            //$('.my-modal').fadeOut();
            //$body.removeClass('no-scroll');

            //log('PPPPPPpied.');
            navigator.clipboard.writeText(report_summary)   // debug:   ctripOrderThing[9]
            .then(() => {
                //log('Text copied.');
            })
            .catch(() => {
                //log('Failed to write clipboard');
            });

            $('#btn_JTB_confirmed').delay(35).queue(function(){
                window.close();
            });

        });
        
        // 新开页面，不再使用“开始接单”按钮
        // $('#btn_start_process').on('click', function () { }); 

        var gName1;                 // 用于JTB氏名報告
        var gName = new Array();    // 用于存放所有客人姓名，从入住人1开始
        gName[0] = "";

        /** Read from clipboard when clicking the Paste button */
        navigator.clipboard.readText()
        .then(text => {
            
            var pasteStr = text;        // 此处开始引入ctripOrderInfo的处理
            //log('Text pasted.');
        
            ctripOrderInfo_extracting_block: {

                var ctripOrderThing=new Array();

                var regExp_ctripOrderRef=/订单号\s+(\d{10})/;
                ctripOrderThing[0]=pasteStr.match(regExp_ctripOrderRef);
                var ctripOrderRef=RegExp.$1;

                var regExp_ctripOrderType=/订单类型\s+(..)/;
                ctripOrderThing[1]=pasteStr.match(regExp_ctripOrderType);
                var ctripOrderType=RegExp.$1;

                var regExp_ctripOrderPrice=/订单金额\s+JPY(.+)\s/;
                ctripOrderThing[2]=pasteStr.match(regExp_ctripOrderPrice);
                var ctripOrderPrice=parseInt(RegExp.$1);

                var regExp_ctripOrderHotel=/酒店名称\s+(.+)\(/;
                ctripOrderThing[3]=pasteStr.match(regExp_ctripOrderHotel);
                var ctripOrderHotel=RegExp.$1;
                var hotelIndexName=ctripOrderHotel.substr(0, 3);
                var hotelNickName;

                var regExp_ctripOrderRoomtype=/入住信息\s+房型\s+([\u4E00-\u9FFF]+).+/;
                var regExp_ctripOrderEach_Case1=/入住信息\s+房型\s+.+(.人入住)/;
                var regExp_ctripOrderEach_Case2=/入住信息\s+房型\s+.*([双大中标][人床准][床房])/;
                ctripOrderThing[4]=pasteStr.match(regExp_ctripOrderRoomtype);
                var ctripOrderRoomtype=RegExp.$1;
                var ctripOrderEachRoom;
                if ( pasteStr.match(regExp_ctripOrderEach_Case1) ){
                    ctripOrderEachRoom=RegExp.$1;
                } else if ( pasteStr.match(regExp_ctripOrderEach_Case2) ){
                    ctripOrderEachRoom="二人入住";
                }
                //接下来需要计算总共人=每间人数*间数     "男9"		要订 (间数) 间房

                var regExp_ctripOrderDate=/入离时间\s+(20\d\d\W\d\d\W\d\d).+(20\d\d\W\d\d\W\d\d).+\d+晚/;
                ctripOrderThing[5]=pasteStr.match(regExp_ctripOrderDate);
                var ctripOrderDate1=RegExp.$1;
                var ctripOrderDate2=RegExp.$2;
                var d1 = new Date(ctripOrderDate1);
                var d2 = new Date(ctripOrderDate2);
                var ctripOrderNights = parseInt((d2 - d1) / (1000 * 3600 * 24)); 
                var getDayOfWeek = ['日','月','火','水','木','金','土'];
                var Date1_dayName = getDayOfWeek[d1.getDay()];
                
                var regExp_ctripOrderRooms=/预订间数\s+(\d+)/;
                ctripOrderThing[6]=pasteStr.match(regExp_ctripOrderRooms);
                var ctripOrderRooms=RegExp.$1;

                var regExp_ctripOrderPeoples=/入住人数\s+(\d+)/;
                ctripOrderThing[7]=pasteStr.match(regExp_ctripOrderPeoples);
                var ctripOrderPeoples=RegExp.$1;
                //ctripOrderPeoples是订单通知人数。订单通知人数 ≤ 实际入住人数 ≤ 预订可住人数

                var regExp_ctripOrderMeals=/房型\s+.+([\u4e00-\u9fa5]早|早\+晚餐)/;
                ctripOrderThing[8]=pasteStr.match(regExp_ctripOrderMeals);
                var ctripOrderMeals=RegExp.$1;

                var regExp_ctripOrderGuestname=/入住人\d+\s+([\w ]+\/[\w ]+)/;
                ctripOrderThing[9]=pasteStr.match(regExp_ctripOrderGuestname);
                var GuestnameList=RegExp.$1.split(/\n+/);
                //if(GuestnameList.length!=ctripOrderPeoples){/* 入住人名字列表没能成功获取完成 */}
                //转换成jtbGuestName以护照格式为准：去空格，改大写，姓与名中间的/改为半角空格

                var regExp_ctripOrderSpecialrequest=/特殊要求\s+(.+)\s+/;
                ctripOrderThing[10]=pasteStr.match(regExp_ctripOrderSpecialrequest);
                var ctripOrderSpecialrequest=RegExp.$1;
                //内容可能很多，只是展示出来，然后提供高階層等等标签供复制选用

                var regExp_ctripOrderComment=/备注\n{1,2}(..)/;
                ctripOrderThing[11]=pasteStr.match(regExp_ctripOrderComment);
                //if(RegExp.$1){/* 提醒用户备注栏里有内容 */}

            }
            
            Key_Info_treatment: {

                // 显示内容的前处理     
                var HHHHname = ctripOrderHotel;     // HHHHname是酒店的四字簡称
                HHHHname = HHHHname.replace("北海道","");
                HHHHname = HHHHname.replace("度假村","");
                HHHHname = HHHHname.replace("度假","");
                HHHHname = HHHHname.replace("大酒店","");
                HHHHname = HHHHname.replace("酒店","");
                HHHHname = HHHHname.replace("大饭店","");
                HHHHname = HHHHname.replace("饭店","");
                HHHHname = HHHHname.replace("TOMAMU","");
                
                var DATEshow = ctripOrderDate1;
                DATEshow = DATEshow.replace("2018","18");
                DATEshow = DATEshow.replace("2019","19");
                var periodDays = ctripOrderNights + 1;

                gName1 = GuestnameList[0].toUpperCase().replace('/','_');
                gName1 = gName1.replace(/\W/g,"").replace('_',' ');

                var numEachRoom;
                if (ctripOrderEachRoom.match(/[单一]人/)) { numEachRoom = "1"; }
                else if (ctripOrderEachRoom.match(/[双两二]人/)) { numEachRoom = "2"; }
                else if (ctripOrderEachRoom.match(/三人/)) { numEachRoom = "3"; }
                else if (ctripOrderEachRoom.match(/四人/)) { numEachRoom = "4"; }
                else { numEachRoom = "X"; alert(" numEachRoom ERROR! "); }

                var totalPeopleNum = numEachRoom * ctripOrderRooms;
                
                var SPshow = ctripOrderSpecialrequest;
                SPshow = SPshow.replace("High floor preferred"," *高階層希望 ");
                SPshow = SPshow.replace("Nonsmoking preferred"," *禁煙室 ");
                SPshow = SPshow.replace("Quiet room preferred","");
                SPshow = SPshow.replace("Honeymoon amenity preferred","");
                SPshow = SPshow.replace("Prefer ","*Prefer ");
                SPshow = SPshow.replace(";"," ");
                SPshow = SPshow.replace("。"," ");

/*
                for ( var Hcheck=0; Hcheck<90; Hcheck++ ){
                    var thisHotelInfo = HnameTable[Hcheck];
                    if ( HHHHname.match(thisHotelInfo[0]) ){ HnameSummary = thisHotelInfo[1]; break; } 
                }
*/                
                
                /*
                if ( GuestnameList.length != ctripOrderPeoples ){
                    alert("姓名列表未能完整获取 : " + GuestnameList.length + " 不等于 " + ctripOrderPeoples);
                }
                else {
                    for ( var i = 0 ; i < GuestnameList.length ; i++ )
                        gName[1+i] = GuestnameList[i].toUpperCase().replace(" ","");
                }*/
                                        
                
                // 编辑MS报告


            }

            beside_content_display_block: { 

                document.getElementById("txt_ref").innerHTML = ctripOrderRef;
                document.getElementById("txt_type").innerHTML = ctripOrderType;
                document.getElementById("txt_price").innerHTML = ctripOrderPrice;
                document.getElementById("txt_hotel_roomtype").innerHTML = HHHHname + '　　' + ctripOrderRoomtype;
                document.getElementById("txt_eachroom_meal").innerHTML = ctripOrderEachRoom + '　　' + ctripOrderMeals;
                document.getElementById("txt_rooms").innerHTML = ctripOrderRooms;
                document.getElementById("txt_male_female").innerHTML = totalPeopleNum;
                document.getElementById("txt_checkin").innerHTML = DATEshow + '　' + Date1_dayName;
                document.getElementById("txt_days").innerHTML = periodDays;
                document.getElementById("txt_guest1").innerHTML = gName1;
                document.getElementById("txt_request").innerHTML = SPshow;
                // label#提醒有备注').text('' + recipText)

            }

            modal_content_display_block: { /*

                var modal = $('.my-modal')
                modal.find('.modal-body label#txt_ref').text('单号:　' + ctripOrderRef)
                modal.find('.modal-body label#txt_type').text('' + ctripOrderType)
                modal.find('.modal-body label#txt_price').text(ctripOrderPrice)
                modal.find('.modal-body label#txt_hotel_roomtype').text('' + HHHHname + '　　' + ctripOrderRoomtype)
                modal.find('.modal-body label#txt_eachroom_meal').text('' + ctripOrderEachRoom + '　　' + ctripOrderMeals)
                modal.find('.modal-body label#txt_rooms').text('' + ctripOrderRooms + '　◄ 间数')
                modal.find('.modal-body label#txt_checkin').text('' + ctripOrderDate1 + '　' + Date1_dayName + '　◄ 入住日期')
                modal.find('.modal-body label#txt_days').text('连住 ' + ctripOrderNights + ' 晚')
                modal.find('.modal-body label#txt_guest1').text('氏名1:　' + gName1)
                modal.find('.modal-body label#txt_request').text('　' + ctripOrderSpecialrequest)
                //modal.find('.modal-body label#提醒有备注').text('' + recipText)

                $('.my-modal').fadeIn();
                $body.addClass('no-scroll');

            */ }
            
            report_summary_editing_block: {

                var repo4 = 1 + d1.getMonth();
                var repo5 = d1.getDate();
                var repo6 = 1 + d2.getMonth();
                var repo7 = d2.getDate();

                report_summary = ctripOrderRef +'\t'+ HHHHname +'\t'+ gName1 +'\t'+ repo4 +'\t'+ repo5 +'\t'+ repo6 +'\t'+ repo7 +'\t'+ ctripOrderNights +'\t'+ numEachRoom +'\t'+ ctripOrderRooms +'\t'+ ctripOrderPrice;

            }    

        })
        .catch(() => {
            log(' MAIN process Failed ! ');
        });
        
        
        /* 此处设置120ms延迟，防止readText和writeText同时相应造成异常 */
        //$('#btn_start_process').delay(100).queue(function(){ });
        setTimeout(function(){
            //alert(" setTimeout HERE! " + gName1 );    // 此处如果让alert有效，writeText就不起作用了!
            //log('PPPPPPpied.');
            navigator.clipboard.writeText(gName1)    
            .then(() => {
                //log('Text copied.');
            })
            .catch(() => {
                //log('Failed to write clipboard');
            });
        }, 120);


        

        /* Watch for pastes */
        navigator.clipboard.addEventListener('clipboardchange', e => {
            navigator.clipboard.getText().then( text => {
            log('Updated clipboard contents: '+text)
            })
        });

        /* Since Chrome only allows clipboard access when a tab is the current active, here's a trick: */
        function log(value) {
            clearTimeout(log.timer);
            if (toast.hidden) toast.textContent = value;
            else toast.textContent += '\n' + value;
            toast.className = String(value).match(/error/i) ? 'error' : '';
            toast.hidden = false;
            log.timer = setTimeout( () => { toast.hidden = true; }, 3000);
        }

    </script>
</body>