<div id="toast" hidden></div>

<head>
    <style rel="stylesheet" type="text/css">
        body.no-scroll {
            overflow: hidden;
        }

        .site {
            max-width: 1230px;
            margin: 3em auto;
        }

        .bg {
            background-size: inherit;
            background: url("https://raw.githubusercontent.com/fpga2033/TVtower/gh-pages/bg.jpg") center center;
            height: 505px;
            width: 100%;
            margin-left: -0%;
            margin-top: 3em;
            margin-bottom: 0em;
        }

        .my-modal {
            position: fixed;
            background-color: rgba(255, 255, 255, 0.9);
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            overflow: auto;
        }

        .my-modal-content {
            position: fixed;
            width: 285px;        /* 调整这个宽度，和JTB界面拼接在一起*/
            height: 600px;
            text-align: left;
            padding: 1em;
            background-color: white;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.29), 0 26px 52px rgba(0, 0, 0, 0.26);
        }

        @media only screen and (min-width: 300px) {
            .my-modal-content {
                right: 0%;
                margin-right: -0px;
            }
        }
        @media only screen and (min-height: 580px) {
            .my-modal-content {
                top: 0%;
                margin-top: -0px;
            }
        }

    </style>

</head>

<body>
    <div class="site">
        <section>
            <h1>Sapporo TV Hotel</h1>

            <p>初収録の日に行われた会見。モコモコのクマの部屋着風衣装で登場し、細水長流れ</p>
            <p>実際にはニュージーランドに語学留学した後、オーストラリアにワーキングホリデーで滞在、平淡真実り</p>
            
            <button id="btn_start_process" class="btn btn-primary"><strong>开始接单</strong><br><em>(read from clipboard)</em></button>
        </section>
        <div class="bg"></div>  <!-- 这是BackGround图片 -->
    </div>

    <div class="my-modal">
        <div class="my-modal-content">
            <img hight="10%" width="100%" class="img-rounded" src="https://raw.githubusercontent.com/fpga2033/TVtower/0609769e290f5f11ccf79624a39f594c03a2a4eb/mildseven-hill-winter.jpg" alt="" />
            
            <div class="modal-body">
                <form>
                    <div class="form-group">

                    <label class="control-label" id=txt_ref></label>
                    <label class="control-label" id=txt_type style='float:right'></label><br/>
                    总额:　JPY <label class="control-label" id=txt_price style="font-size:22px;font-family:verdana;color:red"></label><br/><br/>
                    <label class="control-label" id=txt_hotel_roomtype></label><br/><br/>
                    <label class="control-label" id=txt_eachroom_meal></label><br/><br/>
                    <label class="control-label" id=txt_rooms style="color:rgb(86, 0, 121)"></label><br/><br/>
                    <label class="control-label" id=txt_checkin style="color:rgb(86, 0, 121)"></label><br/>
                    <label class="control-label" id=txt_nights style="color:rgb(86, 0, 121)"></label><br/><br/><br/>
                    <label class="control-label" id=txt_guest1></label><br/><br/>
                    <label class="control-label" id=txt_request></label><br/><br/>
                    
                    </div>
                </form>
            </div>
                        
            <button id="btn_res_confirmed" class="btn btn-primary">Close</button>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script type="text/javascript">

        var $body = $('body');
        var report_summary;

        $('#btn_res_confirmed').on('click', function () {
            //alert(" 饿丝了啊 ")
            $('.my-modal').fadeOut();
            $body.removeClass('no-scroll');

            
            //log('PPPPPPpied.');
            navigator.clipboard.writeText(report_summary)    // out 是自定义的文本框id
            .then(() => {
                //log('Text copied.');
            })
            .catch(() => {
                //log('Failed to write clipboard');
            });

        });

        $('#btn_start_process').on('click', function () {
            var gName1;

            /** Read from clipboard when clicking the Paste button */
            navigator.clipboard.readText()
            .then(text => {
                
                var pasteStr = text;        // 此处开始引入ctripOrderInfo的处理
                //log('Text pasted.');
            
                ctripOrderInfo_extracting_block: {

                    var ctripOrderThing=new Array();    

                    var regExp_ctripOrderRef=/订单号\s+(\d{10})/;
                    ctripOrderThing[0]=pasteStr.match(regExp_ctripOrderRef);
                    var ctripOrderRef=RegExp.$1;

                    var regExp_ctripOrderType=/订单类型\s+(..)/;
                    ctripOrderThing[1]=pasteStr.match(regExp_ctripOrderType);
                    var ctripOrderType=RegExp.$1;

                    var regExp_ctripOrderPrice=/订单金额\s+JPY(.+)\s/;
                    ctripOrderThing[2]=pasteStr.match(regExp_ctripOrderPrice);
                    var ctripOrderPrice=parseInt(RegExp.$1);

                    var regExp_ctripOrderHotel=/酒店名称\s+(.+)\(/;
                    ctripOrderThing[3]=pasteStr.match(regExp_ctripOrderHotel);
                    var ctripOrderHotel=RegExp.$1;
                    var hotelIndexName=ctripOrderHotel.substr(0, 3);
                    var hotelNickName;

                    var regExp_ctripOrderRoomtype=/入住信息\s+房型\s+([\u4E00-\u9FFF]+).+/;
                    var regExp_ctripOrderEach_Case1=/入住信息\s+房型\s+.+(.人入住)/;
                    var regExp_ctripOrderEach_Case2=/入住信息\s+房型\s+.*([双大中标][人床准][床房])/;
                    ctripOrderThing[4]=pasteStr.match(regExp_ctripOrderRoomtype);
                    var ctripOrderRoomtype=RegExp.$1;
                    var ctripOrderEachRoom;
                    if ( pasteStr.match(regExp_ctripOrderEach_Case1) ){
                        ctripOrderEachRoom=RegExp.$1;
                    } else if ( pasteStr.match(regExp_ctripOrderEach_Case2) ){
                        ctripOrderEachRoom="二人入住";
                    }
                    //接下来需要计算总共人=每间人数*间数     "男9"		要订 (间数) 间房

                    var regExp_ctripOrderDate=/入离时间\s+(20\d\d\W\d\d\W\d\d).+(20\d\d\W\d\d\W\d\d).+\d+晚/;
                    ctripOrderThing[5]=pasteStr.match(regExp_ctripOrderDate);
                    var ctripOrderDate1=RegExp.$1;
                    var ctripOrderDate2=RegExp.$2;
                    var d1 = new Date(ctripOrderDate1);
                    var d2 = new Date(ctripOrderDate2);
                    var ctripOrderNights = parseInt((d2 - d1) / (1000 * 3600 * 24)); 
                    var getDayOfWeek = ['周日','周一','周二','周三','周四','周五','周六'];
                    var Date1_dayName = getDayOfWeek[d1.getDay()];
                    
                    var regExp_ctripOrderRooms=/预订间数\s+(\d+)/;
                    ctripOrderThing[6]=pasteStr.match(regExp_ctripOrderRooms);
                    var ctripOrderRooms=RegExp.$1;

                    var regExp_ctripOrderPeoples=/入住人数\s+(\d+)/;
                    ctripOrderThing[7]=pasteStr.match(regExp_ctripOrderPeoples);
                    var ctripOrderPeoples=RegExp.$1;
                    //ctripOrderPeoples是订单通知人数。订单通知人数 ≤ 实际入住人数 ≤ 预订可住人数

                    var regExp_ctripOrderMeals=/房型\s+.+([\u4e00-\u9fa5]早|早\+晚餐)/;
                    ctripOrderThing[8]=pasteStr.match(regExp_ctripOrderMeals);
                    var ctripOrderMeals=RegExp.$1;

                    var regExp_ctripOrderGuestname=/入住人\d+\s+([\w ]+\/[\w ]+)/;
                    ctripOrderThing[9]=pasteStr.match(regExp_ctripOrderGuestname);
                    var GuestnameList=RegExp.$1.split(/\n+/);
                    //if(GuestnameList.length!=ctripOrderPeoples){/* 入住人名字列表没能成功获取完成 */}
                    //转换成jtbGuestName以护照格式为准：去空格，改大写，姓与名中间的/改为半角空格

                    var regExp_ctripOrderSpecialrequest=/特殊要求\s+(.+)\s+/;
                    ctripOrderThing[10]=pasteStr.match(regExp_ctripOrderSpecialrequest);
                    var ctripOrderSpecialrequest=RegExp.$1;
                    //内容可能很多，只是展示出来，然后提供高階層等等标签供复制选用

                    var regExp_ctripOrderComment=/备注\n{1,2}(..)/;
                    ctripOrderThing[11]=pasteStr.match(regExp_ctripOrderComment);
                    //if(RegExp.$1){/* 提醒用户备注栏里有内容 */}

                }
                
                modal_content_editing_block: {

                    /* 显示内容的前处理 */    
                    var HHHH=ctripOrderHotel.replace("度假村","");
                    HHHH=HHHH.replace("酒店","");
                    gName1=GuestnameList[0].toUpperCase().replace('/','_');
                    gName1=gName1.replace(/\W/g,"").replace('_',' ');

                    var modal = $('.my-modal')
                    modal.find('.modal-body label#txt_ref').text('单号:　' + ctripOrderRef)
                    modal.find('.modal-body label#txt_type').text('' + ctripOrderType)
                    modal.find('.modal-body label#txt_price').text(ctripOrderPrice)
                    modal.find('.modal-body label#txt_hotel_roomtype').text('' + HHHH + '　　' + ctripOrderRoomtype)
                    modal.find('.modal-body label#txt_eachroom_meal').text('' + ctripOrderEachRoom + '　　' + ctripOrderMeals)
                    modal.find('.modal-body label#txt_rooms').text('' + ctripOrderRooms + '　◄ 间数')
                    modal.find('.modal-body label#txt_checkin').text('' + ctripOrderDate1 + '　' + Date1_dayName + '　◄ 入住日期')
                    modal.find('.modal-body label#txt_nights').text('连住 ' + ctripOrderNights + ' 晚')
                    modal.find('.modal-body label#txt_guest1').text('氏名1:　' + gName1)
                    modal.find('.modal-body label#txt_request').text('　' + ctripOrderSpecialrequest)
                    //modal.find('.modal-body label#提醒有备注').text('' + recipText)

                    $('.my-modal').fadeIn();
                    $body.addClass('no-scroll');

                }
                
                var repo4 = 1 + d1.getMonth();
                var repo5 = d1.getDate();
                var repo6 = 1 + d2.getMonth();
                var repo7 = d2.getDate();
                var numEachRoom;
                if (ctripOrderEachRoom.match(/[单一]人/)) { numEachRoom = "1"; }
                else if (ctripOrderEachRoom.match(/[双两二]人/)) { numEachRoom = "2"; }
                else if (ctripOrderEachRoom.match(/三人/)) { numEachRoom = "3"; }
                else if (ctripOrderEachRoom.match(/四人/)) { numEachRoom = "4"; }
                else { numEachRoom = "X"; }
                report_summary = ctripOrderRef +'\t'+ HHHH +'\t'+ gName1 +'\t'+ repo4 +'\t'+ repo5 +'\t'+ repo6 +'\t'+ repo7 +'\t'+ ctripOrderNights +'\t'+ numEachRoom +'\t'+ ctripOrderRooms;
            })
            .catch(() => {
                log('Failed to read clipboard');
            });
            
            
            //setTimeout(alert("Hereee"), 3000);
            $('#btn_start_process').delay(200).queue(function(){

                //log('PPPPPPpied.');
                navigator.clipboard.writeText(gName1)    // out 是自定义的文本框id
                .then(() => {
                    //log('Text copied.');
                })
                .catch(() => {
                    //log('Failed to write clipboard');
                });

            });

            /** Write contents of the textarea to the clipboard when clicking "btn_res_confirmed" 
            btn_res_confirmed.onclick = function() {
                navigator.clipboard.writeText(out.value)    // out 是自定义的文本框id
                .then(() => {
                    log('Text copied.');
                })
                .catch(log);
            };*/

        });    

        /* Watch for pastes */
        navigator.clipboard.addEventListener('clipboardchange', e => {
            navigator.clipboard.getText().then( text => {
            log('Updated clipboard contents: '+text)
            })
        });

        /* Since Chrome only allows clipboard access when a tab is the current active, here's a trick: */
        function log(value) {
            clearTimeout(log.timer);
            if (toast.hidden) toast.textContent = value;
            else toast.textContent += '\n' + value;
            toast.className = String(value).match(/error/i) ? 'error' : '';
            toast.hidden = false;
            log.timer = setTimeout( () => { toast.hidden = true; }, 3000);
        }

    </script>
</body>